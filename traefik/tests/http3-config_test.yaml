suite: Http3 configuration
templates:
  - deployment.yaml
tests:
  - it: should inject the experimental flag if sepcified
    set:
      experimental:
        http3:
          enabled: true
    asserts:
      - contains:
          path: spec.template.spec.containers[0].args
          content: "--experimental.http3=true"

  - it: should not have any http3 config by default
    set:
      ports:
        websecure:
          tls:
            enabled: true
    asserts:
      # >=2.6.0
      - notContains:
          path: spec.template.spec.containers[0].args
          content: "--entrypoints.websecure.enabledHTTP3=true"
      # <2.6.0
      - notContains:
          path: spec.template.spec.containers[0].args
          content: "--entrypoints.websecure.http3"

  - it: should have no http3 arguments when tls is disabled
    set:
      ports:
        websecure:
          http3: {}
          tls:
            enabled: false
    asserts:
      # >=2.6.0
      - notContains:
          path: spec.template.spec.containers[0].args
          content: "--entrypoints.websecure.enabledHTTP3=true"
      # <2.6.0
      - notContains:
          path: spec.template.spec.containers[0].args
          content: "--entrypoints.websecure.http3"

  - it: should use enabledHTTP3 when the the version <2.6.0
    set:
      image:
        tag: 2.5.6
      ports:
        websecure:
          http3: {}
          tls:
            enabled: true
    asserts:
      - contains:
          path: spec.template.spec.containers[0].args
          content: "--entrypoints.websecure.enabledHTTP3=true"

  - it: should specify advertisedPort when the the version >=2.6.0
    set:
      image:
        tag: 2.6.0
      ports:
        websecure:
          http3:
            advertisedPort: 443
          tls:
            enabled: true
    asserts:
      - contains:
          path: spec.template.spec.containers[0].args
          content: "--entrypoints.websecure.http3"
      - contains:
          path: spec.template.spec.containers[0].args
          content: "--entrypoints.websecure.http3.advertisedPort=443"
